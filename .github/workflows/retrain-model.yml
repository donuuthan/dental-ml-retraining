name: Auto-Retrain ML Model

on:
  schedule:
    # Run every Sunday at 2 AM UTC (adjust for your timezone)
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual trigger from GitHub Actions UI

jobs:
  retrain:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install firebase-admin
      
      - name: Configure Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        run: |
          mkdir -p .firebase
          echo "$FIREBASE_SERVICE_ACCOUNT_KEY" > .firebase/serviceAccountKey.json
          export FIREBASE_SERVICE_ACCOUNT_KEY=".firebase/serviceAccountKey.json"
      
      - name: Run model retraining
        run: |
          export FIREBASE_SERVICE_ACCOUNT_KEY=".firebase/serviceAccountKey.json"
          python auto_retrain_model.py
      
      - name: Check if model was updated
        id: check-model
        run: |
          if [ -f "smart_scheduler.pkl" ]; then
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "Model file exists and was updated"
          else
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "Model file not found"
          fi
      
      - name: Commit updated model (if changed)
        if: steps.check-model.outputs.updated == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add smart_scheduler.pkl
          git add retraining.log
          git diff --staged --quiet || git commit -m "ðŸ¤– Auto-retrained ML model [skip ci]"
          git push || echo "No changes to commit"
      
      - name: Upload retraining logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: retraining-logs
          path: retraining.log
          retention-days: 30

